<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://jbritain.net/stylesheet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spark-md5/3.0.2/spark-md5.min.js"></script>
  </head>
  <body>
    <noscript>
      <dialog open>
        <h1>JavaScript disabled!</h1>
        <p>
          This tool doesn't work without JavaScript. To be clear, it also
          doesn't track you, or mine bitcoin, or do anything nefarious. Don't
          believe me?
          <a href="https://github.com/jbritain/patchbin">Check for yourself.</a>
        </p>
        <p>
          What it does do, though, is run all processing client-side. No data is
          ever sent to a server, because not only do I not want to pay the cost
          of hosting something like that, but I also think that there's no point
          in doing it that way if it's possible to do it on the client.
        </p>
        <br />
        <p>
          So, as much as it may pain you, if you want to use this tool, you will
          need to add this site to your JavaScript whitelist.
        </p>
      </dialog>
    </noscript>

    <h1 style="margin-bottom: 0px">patchbin</h1>
    <small>by <a href="https://jbritain.net">jbritain</a></small>
    <p>
      a utility for generating binary patches that can be used to reconstruct a
      modified version of a file without directly distributing that modification
    </p>
    <hr />
    <p>
      if you are looking to generate a patch file to distribute, click the
      button at the bottom, upload the original file and your modified version,
      and click "generate patch". you can then safely distribute the downloaded
      '.bin' file without violating any licensing agreements.
    </p>
    <p>
      if you have been given a patch file, upload the original file and the
      patch file, and click "apply patch".
    </p>
    <p>
      if you find this utility useful, consider
      <a href="https://ko-fi.com/jbritain">donating</a> to help me keep the
      lights on.
    </p>
    <p>
      <b
        >note: as this is a binary patch, the file being patched must always be
        exactly the same. in the case of a zip archive, if the metadata of any
        files within the archive is different (such as the last modified date),
        the patch will fail.</b
      >
    </p>
    <p>
      <b>large file support:</b> this tool now supports files larger than 1GB through 
      chunked processing. files are processed in 64MB chunks to minimize memory usage. 
      very large files (>2GB) will show a warning about processing time and memory requirements.
    </p>
    <hr />
    <label for="original-file">original file</label>
    <input type="file" id="original-file" />
    <div style="display: none" class="generation-stuff">
      <br />
      <label for="modified-file">modified file</label>
      <input type="file" id="modified-file" />
    </div>
    <br />
    <label for="patch-file">patch file</label>
    <input accept=".bin" type="file" id="patch-file" />
    <br />

    <script src="./diff.js"></script>

    <hr />

    <div style="display: none" class="generation-stuff">
      <button onclick="tryGeneratePatch()">Generate Patch</button>
    </div>
    <button onclick="tryApplyPatch()">Apply Patch</button>

    <div id="progress-container" style="display: none; margin: 20px 0;">
      <div id="progress-text" style="margin-bottom: 10px;">Processing...</div>
      <div style="width: 100%; background-color: #f0f0f0; border-radius: 5px; overflow: hidden;">
        <div id="progress-bar" style="width: 0%; height: 20px; background-color: #4CAF50; transition: width 0.3s ease;"></div>
      </div>
      <div id="progress-details" style="margin-top: 10px; font-size: 0.9em; color: #666;"></div>
    </div>

    <p id="error-text" style="color: red"></p>

    <div id="patch-generation-enable">
      <button onclick="window.location.href += '#generate'; showOptions();">
        Show patch generation
      </button>
      <p>
        Patch generation is hidden by default to make this tool more accessible
        to users who are only applying the patch.
      </p>
    </div>

    <a href="https://github.com/jbritain/patchbin"
      >View the Source Code on GitHub</a
    >

    <script>
      function showOptions() {
        Array.prototype.forEach.call(
          document.getElementsByClassName("generation-stuff"),
          (e) => {
            e.style.display = "initial";
          },
        );
        document.querySelector("#patch-generation-enable").style.display =
          "none";
      }
      if (window.location.hash == "#generate") {
        showOptions();
      }

      // Progress tracking functionality
      window.updateProgress = function(message, percentage) {
        const progressContainer = document.querySelector("#progress-container");
        const progressText = document.querySelector("#progress-text");
        const progressBar = document.querySelector("#progress-bar");
        const progressDetails = document.querySelector("#progress-details");
        
        progressContainer.style.display = "block";
        progressText.innerText = message;
        
        // Extract percentage from message if not provided separately
        if (percentage === undefined) {
          const match = message.match(/(\d+)%/);
          percentage = match ? parseInt(match[1]) : 0;
        }
        
        progressBar.style.width = percentage + "%";
        
        // Add file size information for large files
        if (window.processingState && window.processingState.originalFile) {
          const originalSize = (window.processingState.originalFile.size / (1024 * 1024 * 1024)).toFixed(2);
          const modifiedSize = window.processingState.modifiedFile ? 
            (window.processingState.modifiedFile.size / (1024 * 1024 * 1024)).toFixed(2) : 'N/A';
          progressDetails.innerHTML = `Original file: ${originalSize} GB | Modified file: ${modifiedSize} GB`;
        }
        
        // Hide progress when complete
        if (message.includes("complete!")) {
          setTimeout(() => {
            progressContainer.style.display = "none";
          }, 3000);
        }
      };

      // Make processingState globally accessible for progress updates
      window.processingState = processingState;
    </script>
  </body>
</html>
